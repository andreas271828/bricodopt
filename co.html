<!-- (c) Copyright 2015 Andreas Huemer. All rights reserved. -->
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Codon optimisation</title>
		<script>
			// FIX: Tests.
			var normaliseSequence = function(sequence) {
				return sequence.replace(/\s/g, "");
			};

			var getAminoAcid = function(codon) {
				// https://en.wikipedia.org/wiki/DNA_codon_table
				// FIX: Better format (e.g. compressed format)?
				// FIX: Test.
				switch (codon) {
					case "GCT":
					case "GCC":
					case "GCA":
					case "GCG":
						return "A";
					case "TGT":
					case "TGC":
						return "C";
					case "GAT":
					case "GAC":
						return "D";
					case "GAA":
					case "GAG":
						return "E";
					case "TTT":
					case "TTC":
						return "F";
					case "GGT":
					case "GGC":
					case "GGA":
					case "GGG":
						return "G";
					case "CAT":
					case "CAC":
						return "H";
					case "ATT":
					case "ATC":
					case "ATA":
						return "I";
					case "AAA":
					case "AAG":
						return "K";
					case "TTA":
					case "TTG":
					case "CTT":
					case "CTC":
					case "CTA":
					case "CTG":
						return "L";
					case "ATG":
						return "M";
					case "AAT":
					case "AAC":
						return "N";
					case "CCT":
					case "CCC":
					case "CCA":
					case "CCG":
						return "P";
					case "CAA":
					case "CAG":
						return "Q";
					case "CGT":
					case "CGC":
					case "CGA":
					case "CGG":
					case "AGA":
					case "AGG":
						return "R";
					case "TCT":
					case "TCC":
					case "TCA":
					case "TCG":
					case "AGT":
					case "AGC":
						return "S";
					case "ACT":
					case "ACC":
					case "ACA":
					case "ACG":
						return "T";
					case "GTT":
					case "GTC":
					case "GTA":
					case "GTG":
						return "V";
					case "TGG":
						return "W";
					case "TAT":
					case "TAC":
						return "Y";
					case "TAA":
					case "TGA":
					case "TAG":
						return ".";
				}
				return "?";
			};

			var getAminoAcids = function(sequence) {
				// FIX: No mutations.
				var ret = "";
				var rest = sequence;
				while (rest.length >= 3) {
					ret = ret.concat(getAminoAcid(rest.substring(0, 3)));
					rest = rest.substring(3);
				}
				return ret;
			};

			var addToFrequencyMap = function(frequencyMap, aminoAcid, codon, frequency) {
				if (frequencyMap[aminoAcid] === undefined) {
					frequencyMap[aminoAcid] = {
						codons: [],
						sum: 0
					};
				}
				frequencyMap[aminoAcid].codons.push({
					codon: codon,
					frequency: frequency
				});
				frequencyMap[aminoAcid].sum = frequencyMap[aminoAcid].sum + frequency;
			};

			var getFrequencyMap = function(frequencies) {
				var frequencyMap = {};
				var normalised = frequencies.replace(/U/g, "T");
				var items = normalised.split(/\([^)]*\)\s*/);
				items.forEach(function(item) {
					if (item !== "") {
						var data = item.split(/\s+/);
						var codon = data[0];
						var frequency = parseFloat(data[1]);
						var aminoAcid = getAminoAcid(codon);
						addToFrequencyMap(frequencyMap, aminoAcid, codon, frequency);
					}
				});

				// Normalise frequency map
				for (var key in frequencyMap) {
					if (frequencyMap.hasOwnProperty(key)) {
						if (frequencyMap[key].sum > 0) {
							frequencyMap[key].codons.forEach(function(item) {
								item.frequency /= frequencyMap[key].sum;
							});
						}
					}
				}

				return frequencyMap;
			};

			var getCodon = function(aminoAcid, frequencyMap) {
				var codons = frequencyMap[aminoAcid].codons;
				if (codons.length > 0) {
					var sel = Math.random();
					var acc = 0;
					for (var i = 0; i < codons.length - 1; i++) {
						acc += codons[i].frequency;
						if (sel < acc) {
							return codons[i].codon;
						}
					}
					return codons[codons.length - 1].codon;
				}
				return "???";
			};

			var getSequence = function(aminoAcids, frequencyMap) {
				// FIX: No mutations.
				var ret = "";
				for (var i = 0; i < aminoAcids.length; i++) {
					ret = ret.concat(getCodon(aminoAcids.charAt(i), frequencyMap));
				}
				return ret;
			};

			var optimise = function() {
				var sequence1 = document.getElementById("sequence1").value;
				var normalised1 = normaliseSequence(sequence1);
				var aminoAcids = getAminoAcids(normalised1);
				document.getElementById("aminoAcids").value = aminoAcids;
				var frequencies = document.getElementById("frequencies").value;
				if (frequencies !== "") {
					var frequencyMap = getFrequencyMap(frequencies);
					document.getElementById("sequence2").value = getSequence(aminoAcids, frequencyMap);
				}
			};
		</script>
  </head>

	<body>
	<p>Example sequence:<br/>
	ATGGTGAGCAAGGGCGAGGAGCTGTTCACCGGGGTGGTGCCCATCCTGGTCGAGCTGGACGGCGACGTAAACGGCCACAA GTTCAGCGTGTCCGGCGAGGGCGAGGGCGATGCCACCTACGGCAAGCTGACCCTGAAGTTCATCTGCACCACCGGCAAGC TGCCCGTGCCCTGGCCCACCCTCGTGACCACCTTCGGCTACGGCCTGCAGTGCTTCGCCCGCTACCCCGACCACATGAAG CAGCACGACTTCTTCAAGTCCGCCATGCCCGAAGGCTACGTCCAGGAGCGCACCATCTTCTTCAAGGACGACGGCAACTA CAAGACCCGCGCCGAGGTGAAGTTCGAGGGCGACACCCTGGTGAACCGCATCGAGCTGAAGGGCATCGACTTCAAGGAGG ACGGCAACATCCTGGGGCACAAGCTGGAGTACAACTACAACAGCCACAACGTCTATATCATGGCCGACAAGCAGAAGAAC GGCATCAAGGTGAACTTCAAGATCCGCCACAACATCGAGGACGGCAGCGTGCAGCTCGCCGACCACTACCAGCAGAACAC CCCCATCGGCGACGGCCCCGTGCTGCTGCCCGACAACCACTACCTGAGCTACCAGTCCGCCCTGAGCAAAGACCCCAACG AGAAGCGCGATCACATGGTCCTGCTGGAGTTCGTGACCGCCGCCGGGATCACTCTCGGCATGGACGAGCTGTACAAGTAA
	</p>

	<p>
		Original sequence:&nbsp;<input id="sequence1" onkeyup="optimise()">
	</p>

	<p>
		Amino acids:&nbsp;<input id="aminoAcids">
	</p>

	<p>Example frequencies:<br/>
		<pre>
UUU 33.4(   894)  UCU 17.0(   455)  UAU 24.6(   657)  UGU  7.6(   203)
UUC 17.1(   456)  UCC  2.8(    74)  UAC 10.0(   266)  UGC  1.5(    39)
UUA 77.7(  2078)  UCA 22.0(   588)  UAA  2.9(    78)  UGA  0.1(     3)
UUG  4.3(   114)  UCG  4.0(   107)  UAG  0.4(    12)  UGG 13.5(   361)

CUU 14.3(   383)  CCU 15.5(   414)  CAU 10.1(   270)  CGU 32.4(   866)
CUC  1.0(    28)  CCC  3.4(    90)  CAC  8.8(   235)  CGC  4.1(   110)
CUA  6.4(   170)  CCA 23.6(   630)  CAA 38.4(  1026)  CGA  3.4(    90)
CUG  3.7(    99)  CCG  2.4(    63)  CAG  4.1(   110)  CGG  0.5(    14)

AUU 51.4(  1374)  ACU 24.4(   651)  AAU 42.1(  1126)  AGU 16.0(   428)
AUC  8.2(   219)  ACC  5.1(   135)  AAC 17.7(   472)  AGC  5.4(   144)
AUA  6.9(   184)  ACA 32.4(   865)  AAA 69.1(  1847)  AGA  5.3(   143)
AUG 22.3(   596)  ACG  3.9(   103)  AAG  6.2(   167)  AGG  0.9(    23)

GUU 29.3(   783)  GCU 34.0(   908)  GAU 25.3(   676)  GGU 44.0(  1177)
GUC  2.5(    68)  GCC  5.9(   159)  GAC  9.8(   263)  GGC  6.4(   172)
GUA 26.0(   696)  GCA 20.7(   554)  GAA 41.1(  1098)  GGA  8.6(   229)
GUG  5.6(   149)  GCG  3.3(    88)  GAG  5.7(   152)  GGG  3.7(    99)
		</pre>
	</p>

	<p>
		Frequencies for optimisation:&nbsp;<input id="frequencies" onkeyup="optimise()">
	</p>

	<p>
		Optimised sequence:&nbsp;<input id="sequence2">
	</p>

	</body>
</html>